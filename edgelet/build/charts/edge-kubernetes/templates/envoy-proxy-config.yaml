---
apiVersion: v1
kind: ConfigMap
metadata:
  name: edgeagentconfigmap
  namespace: {{ .Values.namespace | quote }}
  labels:
    app.kubernetes.io/name: {{ include "edge-kubernetes.name" . }}-edgeagentconfigmap
    helm.sh/chart: {{ include "edge-kubernetes.chart" . }}
    app.kubernetes.io/instance: {{ .Release.Name }}
    app.kubernetes.io/managed-by: {{ .Release.Service }}
data:
  envoy.yaml: |-
    admin:
      access_log_path: /tmp/envoy_admin_access.log
      address:
        socket_address:
          address: 0.0.0.0
          port_value: 9901
    static_resources:
      listeners:
        - name: listener_workload
          address:
            pipe:
              path: /var/run/iotedge/workload.sock
          filter_chains:
            - filters:
                - name: envoy.http_connection_manager
                  config:
                    stat_prefix: ingress_http
                    route_config:
                      name: local_route
                      virtual_hosts:
                        - name: local_service
                          domains: ['*']
                          routes:
                            - match: { prefix: '/' }
                              route: { cluster: service_workload }
                    http_filters:
                      - name: envoy.router
        - name: listener_management
          address:
            pipe:
              path: /var/run/iotedge/mgmt.sock
          filter_chains:
            - filters:
                - name: envoy.http_connection_manager
                  config:
                    stat_prefix: ingress_http
                    route_config:
                      name: local_route
                      virtual_hosts:
                        - name: local_service
                          domains: ['*']
                          routes:
                            - match: { prefix: '/' }
                              route: { cluster: service_management }
                    http_filters:
                      - name: envoy.router
      clusters:
        - name: service_workload
          connect_timeout: 0.25s
          type: LOGICAL_DNS
          hosts:
            - socket_address:
                address: http://{{ .Values.iotedged.service.name }}
                port_value: {{ .Values.iotedged.ports.workload }}
        - name: service_management
          connect_timeout: 0.25s
          type: LOGICAL_DNS
          hosts:
            - socket_address:
                address: http://{{ .Values.iotedged.service.name }}
                port_value: {{ .Values.iotedged.ports.management }}
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: moduleconfigmap
  namespace: {{ .Values.namespace | quote }}
  labels:
    app.kubernetes.io/name: {{ include "edge-kubernetes.name" . }}-moduleconfigmap
    helm.sh/chart: {{ include "edge-kubernetes.chart" . }}
    app.kubernetes.io/instance: {{ .Release.Name }}
    app.kubernetes.io/managed-by: {{ .Release.Service }}
data:
  envoy.yaml: |-
    admin:
      access_log_path: /tmp/envoy_admin_access.log
      address:
        socket_address:
          address: 0.0.0.0
          port_value: 9901
    static_resources:
      listeners:
        - name: listener_workload
          address:
            pipe:
              path: /var/run/iotedge/workload.sock
          filter_chains:
            - filters:
                - name: envoy.http_connection_manager
                  config:
                    stat_prefix: ingress_http
                    route_config:
                      name: local_route
                      virtual_hosts:
                        - name: local_service
                          domains: ['*']
                          routes:
                            - match: { prefix: '/' }
                              route: { cluster: service_workload }
                    http_filters:
                      - name: envoy.router
      clusters:
        - name: service_workload
          connect_timeout: 0.25s
          type: LOGICAL_DNS
          hosts:
            - socket_address:
                address: http://{{ .Values.iotedged.service.name }}
                port_value: {{ .Values.iotedged.ports.workload }}
---
